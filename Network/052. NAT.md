# NAT

---

## 1. NAT(Network Address Translation)이란?

- NAT는 '네트워크 주소 변환(Network Address Translation)'을 의미하는 기술이다.
- IP 패킷의 출발지 또는 목적지의 IP 주소와 포트 번호를 재기록하여 패킷을 전달하는 방식이다.
- 주로 공유기나 라우터 같은 네트워크 장비에서 수행되며, 사설 네트워크(내부망)에 존재하는 여러 컴퓨터들이 하나의 공인 IP 주소를 통해 외부 인터넷과 통신할 수 있도록 도와준다.

### NAT의 기본 동작 원리

- 사설 IP를 가진 내부 장비가 외부 인터넷과 통신하고자 할 때, 공유기는 NAT를 통해 이 사설 IP를 공인 IP로 변환한다. 
- 외부에서는 어떤 사설 IP가 요청을 보냈는지 알 수 없고, 오직 공유기의 공인 IP만을 인식한다. 
- 응답 패킷이 공유기에 도달하면, 공유기는 NAT 테이블에 저장된 정보를 통해 해당 응답을 원래 요청을 보낸 사설 IP에게 전달해준다.

---

## 2. NAT를 사용하는 이유

### 공인 IP 주소의 부족 해결

- 전 세계적으로 사용 가능한 공인 IP의 수는 한정되어 있다. 
- NAT를 사용하면 하나의 공인 IP 주소로 여러 사설 IP를 지원할 수 있어 IP 주소 부족 문제를 해결할 수 있다.

### 보안 강화

- 사설 IP는 외부 인터넷에서 직접 접근할 수 없기 때문에 NAT 자체가 일종의 방화벽 역할을 한다.

### 기존 설정 유지
   
- 공인 IP가 변경되더라도 내부 시스템(서버 등)의 IP 설정은 그대로 유지할 수 있어 관리가 용이하다.

---

## 3. NAT의 종류

### Static NAT (정적 NAT)

#### 정의

- Static NAT는 공인 IP 주소 1개와 사설 IP 주소 1개를 1:1로 고정 매핑하여 변환하는 방식이다.

#### 특징

- 하나의 사설 IP에 대해 항상 동일한 공인 IP가 사용된다. 
- IP 변환이 항상 고정되어 있으므로, 외부에서도 해당 공인 IP만 알면 내부 서버에 접근 가능하다. 
- 보안 설정 및 포트포워딩 작업이 자주 필요한 경우에 적합하다. 
- 서버, CCTV, 프린터 등 항상 고정된 IP 접근이 필요한 경우에 사용된다.

#### 사용 예시

- Elastic IP (AWS): EC2 인스턴스에 고정 공인 IP를 할당할 때 사용 
- Floating IP (OpenStack): 내부 서버에 외부에서 접근 가능하도록 할당하는 공인 IP

#### 주요 용도

- 포트포워딩이 여러 개 필요한 경우 
- 외부에서 정해진 IP로 서비스 제공이 필요한 서버에 사용

### Dynamic NAT (동적 NAT)

#### 정의

- Dynamic NAT는 공인 IP 여러 개와 사설 IP 여러 개를 다대다 매핑하여 변환하는 방식이다.

#### 특징

- 변환 시마다 공인 IP pool 중 하나가 동적으로 할당된다. 
- 특정 사설 IP에 특정 공인 IP가 고정되지 않는다. 
- 공인 IP가 부족할 경우, 동시에 통신할 수 있는 사설 IP 수에 제한이 생긴다. 
- 한 번 할당된 공인 IP는 일정 시간 동안 유지되지만, 세션이 끝나면 회수된다.

#### 장점

- 공인 IP 자원을 효율적으로 관리할 수 있다. 
- 많은 사설 IP 주소가 적은 수의 공인 IP로 인터넷을 이용할 수 있다.

#### 주의

- 외부에서 내부로의 직접 접속이 어렵다 (IP가 고정되지 않기 때문). 
- 보통 서버보다는 클라이언트 기반의 일시적인 통신에 적합하다.

#### 포트 번호의 범위

- 포트 번호는 총 0 ~ 65535번까지 존재 
- 0~1023번 포트는 Well-known Port라고 하며, 다음과 같은 대표적인 프로토콜이 사용:
  - 20, 21: FTP 
  - 22: SSH 
  - 23: Telnet 
  - 25: SMTP 
  - 53: DNS 
  - 80: HTTP 
  - 443: HTTPS 등

### PAT (Port Address Translation) / Overloading

- PAT는 공인 IP 주소가 1개밖에 없을 때 여러 사설 IP 주소를 인터넷과 통신할 수 있도록 해주는 기술이다. 
- 이 방식은 하나의 공인 IP를 여러 사설 IP가 포트 번호를 이용해 공유하는 방식이다.
- 일반적으로 가정용 공유기나 기업 네트워크에서 가장 널리 사용된다.

#### 작동 원리
   
- 사내망의 호스트 A가 외부 서버에 통신을 요청하면, NAT 장비(예: 공유기)는 A의 사설 IP와 포트를 공인 IP + 새로운 포트 번호로 변환하여 전송한다. 
- 이때, IP 주소는 바뀌지만 포트 번호는 기억된다. 
- 외부 서버의 응답은 변환된 공인 IP와 포트 번호로 돌아오게 되고, NAT 장비는 기억하고 있던 포트 번호 정보를 바탕으로 다시 원래의 사설 IP와 포트로 복원하여 내부 호스트에 전달해준다.
  - 포트 번호 8001을 통해 해당 요청이 어떤 내부 장비에서 왔는지 식별 가능

---

## 3. Port Forwarding (포트 포워딩)

### 개념

- 사설 IP를 사용하는 PC는 NAT 테이블에 기록된 내용이 있을 때만 외부와 직접적으로 통신할 수 있다.
- 즉, 내부에서 외부로 나가는 요청에 대해 응답이 들어오는 것은 가능하지만, 외부에서 사설 네트워크로 직접 들어오는 요청은 불가능하다.
- 이 문제를 해결하는 방법이 포트포워딩이다.
- 포트포워딩은 NAT를 수행하는 장치에서 설정하며, 특정 포트를 열어서 그 포트를 통해 들어오는 모든 패킷을 내부의 사설 IP로 전달하는 기능이다.

### 포트포워딩의 주요 기능

- 내부에서 나가지 않은 패킷도 포트포워딩을 통해 외부에서 내부로 직접 들어올 수 있게 한다.
- 보통 사설 네트워크 대역에 서버가 있을 때, 해당 서버가 제공하는 서비스를 외부에서 접근 가능하게 할 때 사용된다.

### 예시

- 외부에서 특정 포트로 들어오는 요청을 내부의 사설 IP 서버로 전달하여, 외부 사용자가 사설 네트워크 내의 서버에 접근할 수 있게 한다.

---

## 3. PAT 관련 예시

### MAC 주소로 통신하는 방식 (ARP 프로토콜 활용)

#### 개요

- IP를 알고 있는 상태에서 실제 데이터 통신을 위해 MAC 주소를 알아야 할 때 사용하는 프로토콜이 ARP(Address Resolution Protocol)이다.

#### 통신 흐름

```markdown
▶ src -----> dst (브로드캐스트)
- sender IP: 1.1.1.1
- sender MAC: 000c.000c.000c
- destination IP: 1.1.1.5
- destination MAC: ff:ff:ff:ff:ff:ff (브로드캐스트)

→ 메시지 내용: “나는 1.1.1.1이고 MAC 주소는 000c... 인데, 너희들 중 1.1.1.5가 있다면 MAC 주소 좀 알려줘!”

▶ src <----- dst (응답)
- sender IP: 1.1.1.5
- sender MAC: 000a.000a.000a
- destination IP: 1.1.1.1
- destination MAC: 000c.000c.000c

→ 메시지 내용: “나 1.1.1.5야. 내 MAC 주소는 000a.000a.000a야~”

→ ARP 응답을 받은 호스트는 ARP 테이블에 IP?MAC 매핑 정보를 저장한다.
```

### 동적 PAT (Port Address Translation) 구성

#### 정의

- 동적 PAT는 하나의 공인 IP 주소에 대해 여러 사설 IP 주소들이 포트 번호를 기준으로 공인 IP를 공유하게 하는 NAT 방식이다.

#### 설정 명령어 (Cisco 라우터 예시)

```arduino
(config)# access-list 1 permit any
→ 모든 사설 IP를 변환 대상으로 지정

(config)# ip nat inside source list 1 interface fa0/0 overload
→ 리스트 1에 해당하는 사설 IP들을 fa0/0 인터페이스의 공인 IP로 변환하며,
→ 여러 사설 주소들이 하나의 공인 주소를 공유할 수 있게 "overload" 옵션 사용

(config)# interface fa0/0
(config-if)# ip nat outside
→ 외부(인터넷) 인터페이스 설정

(config)# interface fa0/1
(config-if)# ip nat inside
→ 내부(사설망) 인터페이스 설정
```

#### 예시 흐름

```cpp
내부 클라이언트: http://192.168.1.1xx
→ Router (PAT 적용)
→ 외부 서버: http://172.16.1.100:80
```

### 정적 PAT (Static Port Address Translation)

#### 정의

- 정적 PAT는 공인 IP 주소의 특정 포트 번호를 내부 사설 IP와 포트 번호에 고정 매핑하는 방식이다.

#### 시나리오

- 외부에서 192.168.1.1xx:8001 포트로 접근하면, 내부 172.16.1.100:80 포트로 전달

#### 설정 명령어

```arduino
(config)# ip nat inside source static tcp 172.16.1.100 80 interface fa0/0 8001
→ 내부 IP 172.16.1.100의 80번 포트를 외부에서 fa0/0 인터페이스의 8001 포트로 접근 가능하게 설정
```

### 웹 서버 설정 예시 (Linux)

```swift
root@localhost ~# systemctl start httpd
→ 웹 서버 실행

root@localhost ~# echo "HELLO ALL" > /var/www/html/index.html
→ 웹 페이지 내용 생성

root@localhost ~# systemctl stop firewalld
→ 방화벽 비활성화 (외부 접근 가능하게 하기 위함)

root@localhost ~# cat /var/www/html/index.html
HELLO ALL
→ 웹 서버 응답 확인
```

---

### 참고자료

[NAT](https://velog.io/@yange/NAT%EC%99%80-PAT%EC%97%90-%EB%8C%80%ED%95%98%EC%97%AC)