# DNS 캐싱과 TTL

---

## 1. DNS 캐시란?

- 도메인 이름을 IP 주소로 변환하는 과정에서 조회 결과를 로컬에 저장하는 메커니즘 
- 인터넷 사용 속도를 높이고 네트워크 트래픽을 줄이는 메커니즘이다.
- DNS 서버와 클라이언트 모두에서 구현한다.

### DNS 캐시의 작동 원리

1. 사용자가 웹사이트에 접속하면 브라우저는 로컬 DNS 캐시를 확인한다
2. 캐시에 결과가 없으면 DNS 서버에 요청한다
3. 응답받은 IP 주소를 캐시에 저장한다
4. 캐시는 TTL(Time To Live) 값이 만료되면 삭제된다.

### DNS 캐시의 계층 구조

- 애플리케이션 캐시: 웹 브라우저 등에서 유지
- 운영체제 캐시: OS 차원에서 유지(예 : Window의 DNS Client 서비스)
- 로컬 DNS 서버 캐시: 사내 또는 가정용 DNS 서버
- ISP 또는 네트워크 DNS 서버 캐시: 통신사 DNS 서버
- 상위 DNS 서버 캐시: 공용 DNS 서버 (예: Google DNS)

### DNS 캐시의 장점

- 빠른 응답 시간
  - 캐시에 저장된 결과를 사용하면 DNS 서버를 다시 조회할 필요가 없기 때문
- 네트워크 트래픽 감소
  - 동일한 요청을 반복하지 않기 때문에 네트워크 부하가 감소
- 중복 조회 방지
  - 동일한 DNS 요청을 여러 번 처리하지 않도록 방지

### DNS 캐시의 문제점

- DNS 캐시 포이즈닝: 잘못된 IP가 캐시에 저장될 수 있음(피싱, 데이터 탈취로 이어질 위험이 존재)
- TTL에 따른 지연: 변경된 IP가 반영되지 않을 수 있음
- 캐시 오염: 잘못된 정보가 캐시에 남아 접속 오류 발생 가능

### DNS 캐시 확인 및 관리

- Windows에서 캐시 확인: `ipconfig /displaydns`
- Windows에서 캐시 삭제 (플러시): `ipconfig /flushdns`
  - 새로 죄회하도록 강제

### DNS 캐시 포이즈닝 방지 방법

- DNSSEC 사용
  - DNS 보안 확장을 활성화하여 DNS 응답의 신뢰성을 검증
- 신뢰할 수 있는 DNS 서버 사용 (Google, Cloudflare 등)
- 캐시 TTL 적절히 설정
  - 오래된 데이터가 유지되지 않도록 한다.
- DNS over HTTPS/TLS 등 보안 DNS 프로토콜 사용

### DNS 캐시의 활용 사례

- 기업 네트워크
  - 기업 내부 서비스의 빠른 DNS 해석을 제공
- 웹사이트 성능 최적화
  - 자주 접속하는 사이트 성능 개선
- ISP 서비스
  - 사용자 요청을 캐싱하여 대규모 요청 처리 성능 향상

---

## 2. DNS TTL(Time To Live)이란?

- TTL(Time To Live)은 DNS 리졸버가 DNS 응답 결과를 캐시에 저장해야 하는 시간을 의미한다. 
- TTL 값이 설정되면, 해당 시간 동안 동일한 쿼리에 대해 DNS 서버에 재요청하지 않고 캐시된 결과를 사용한다.

### DNS TTL의 작동 방식

- DNS 응답은 TTL 값을 함께 전달합니다.
- 리졸버는 이 TTL 시간 동안 응답을 캐시에 저장함
- TTL이 만료되면, 캐시를 삭제하고 다시 DNS 서버에 쿼리 요청을 보냄

### DNS TTL이 중요한 이유

- 짧은 TTL
    - IP 변경 시 빠르게 반영됨
    - 오래된 IP 사용 가능성이 줄어듦
    - 보안에 유리
- 긴 TTL
    - 캐시를 더 오래 유지
    - 빠른 응답 속도 제공
    - 서버 요청 수 감소
- DNS TTL은 웹사이트 로딩 속도와 사용자 경험에 큰 영향을 미친다.
- 광고, 트래커, 써드파티 스크립트 등 여러 요소들이 로딩 속도에 영향을 주기 때문에 
- TTL은 적절한 서버 부하와 최적의 응답 속도 사이에서 균형을 맞추는 데 사용된다.

### DNS TTL의 목적

- DNS의 TTL(Time To Live)은 DNS 응답 데이터를 캐시에 저장할 적절한 시간을 설정하는 데 사용된다.
- TTL 설정은 데이터를 너무 자주 갱신하거나, 너무 오래 저장하여 업데이트가 되지 않는 상황을 방지하는 역할을 한다.

### DNS TTL의 활용 예시

- 웹사이트 마이그레이션, 일정 관리
- 웹사이트 로딩 분산 및 서버 부하 완화
- 백업 서버로 빠른 전환
- TTL이 길면 DNS 요청 수가 줄고, TTL이 짧으면 더 자주 최신 정보를 받을 수 있다.

### DNS TTL 설정값과 모범 사례

#### 기본 사항

- TTL은 초 단위로 설정됨
- 최소값은 1초, 일반적으로는 몇 분 ~ 48시간 범위 사용
- 일반적으로 24시간(86,400초) ~ 최대 3일(259,200초)까지 설정 가능

#### TTL 설정 가이드

| 상황 | TTL 권장 값 |
|------|-------------|
| 도메인 IP가 몇 년간 동일한 경우 | 86,400초 |
| 마이그레이션, 테스트 환경 | 300초 |
| DDoS 공격 우려 시 | 43,200초 |
| 장애 조치(failover) 목적 | 600 ~ 1,800초 |
| 클라우드 사용 시 | 서비스 제공자의 권장 TTL 값 참조 |
| 자주 업데이트가 필요한 경우 | 7,200초 |
| 온라인 게임 시 | DNS 서버 자체를 게임용으로 변경 권장 (TTL 변경보다는) |

### 동적 TTL

- 동적 TTL은 실시간 조건에 맞게 자동 조절되는 TTL 방식
- 고정된 TTL 설정보다 유연성이 높음
- 관리자가 상황에 따라 TTL을 동적으로 제어 가능

### DNS TTL 확인 방법

- Windows: `nslookup -type=any domain.com`
- Mac/Linux: `dig domain.com`

### SOA TTL 관련 용어 정리

- SOA(start of authority) 레코드
  - 기본 DNS 서버의 세부 정보, 도메인 관리자의 이메일 주소, 도메인 시리얼 넘버, 새로 고침 및 재시도 타이머 등 도메인에 관한 권한 정보를 제공하는 레코드
- soa ttl: soa 레코드 갱신 주기
- refresh ttl: 보조 서버가 soa를 다시 확인하는 시간
- retry ttl: soa 갱신 실패 시 재시도 시간
- expiry ttl: 갱신 실패가 반복되었을 때 만료로 간주하는 시간
- nx ttl: nxdomain 응답이 캐시에 남아있는 시간
- soa ttl은 민감한 설정이므로 특별한 이유가 없다면 변경하지 않는 것이 좋다.

---

### 참고자료

[DNS 캐싱](https://feccle.tistory.com/345)

[DNS TTL](https://nordvpn.com/ko/blog/ttl-dns/)