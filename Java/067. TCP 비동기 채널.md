# TCP 비동기 채널

---

## 1. 개요

- NIO는 TCP 통신을 위해 블로킹 채널, 넌블로킹 채널 외에도 비동기 채널(Asynchronous Channel) 을 제공한다.
- 주요 클래스는 다음 두 가지다. 
  - AsynchronousServerSocketChannel → ServerSocketChannel에 대응 
  - AsynchronousSocketChannel → SocketChannel에 대응
- 이 두 클래스는 비동기 입출력을 완성하는 NIO의 핵심 요소이다.

---

## 2. 비동기 채널의 특징

- 비동기 채널은 connect(), accept(), read(), write() 메소드를 호출하면 즉시 리턴된다.
- 이 점은 넌블로킹 방식과 같지만, 내부 동작 방식에는 중요한 차이가 있다.
    - 넌블로킹 방식: 호출 즉시 리턴하지만, 직접 상태를 계속 확인해야 한다.
    - 비동기 방식: 호출 즉시 리턴하며, 실제 작업은 스레드풀의 작업 스레드가 처리하고,
- 작업이 끝나면 콜백(callback) 메소드가 자동 실행된다.
    - 즉, 비동기 방식에서는 호출 스레드가 일을 직접 하지 않는다.
- 작업 스레드가 완료 후 자동으로 completed() 메소드를 호출한다.
- 비동기 채널의 모든 I/O 작업(accept, read, write)은 내부적으로 스레드풀을 활용하여 병렬 처리된다.
    - 콜백 기반 구조이므로, 작업 완료 후 실행할 로직은 completed() 내부에 작성한다.
    - read() 메소드의 completed() 콜백에서 result 값이 -1이면, 이는 상대방이 정상적으로 연결을 종료했음을 의미한다.
    - 즉, result == -1은 예외 상황이 아니라 정상적인 연결 종료 신호로 해석해야 한다.

---

## 3. 비동기 채널의 동작 흐름

- 비동기 I/O 호출 과정을 단순화하면 다음과 같다. 
  1. 애플리케이션이 read() 호출 
  2. 메소드는 즉시 리턴 (비동기 호출)
  3. 내부적으로 스레드풀이 read() 작업 수행 
  4. 작업이 완료되면 스레드풀의 스레드가 completed() 콜백 메소드 자동 호출
- 즉, 실제 I/O 수행 스레드는 애플리케이션 스레드가 아니라 스레드풀의 작업 스레드이다.

---

## 4. 비동기 채널 그룹 (AsynchronousChannelGroup)

비동기 채널 그룹은 공통 스레드풀을 공유하는 비동기 채널들의 묶음이다.
서버소켓채널과 소켓채널이 동일한 스레드풀을 사용한다면,
모두 같은 채널 그룹에 포함되어야 한다.

### 기본 채널 그룹

- 비동기 채널을 생성할 때 별도로 그룹을 지정하지 않으면 자동으로 기본 비동기 채널 그룹이 생성된다. 
- 이 기본 그룹은 내부적으로 다음과 같은 스레드풀을 사용한다.
```java
new ThreadPoolExecutor(
    0, Integer.MAX_VALUE,
    Long.MAX_VALUE,
    TimeUnit.MILLISECONDS,
    new SynchronousQueue<Runnable>(),
    threadFactory
);
```
- 이론상 무한히 많은 스레드가 생성될 수 있으므로, 현실적으로는 직접 그룹을 생성하여 관리하는 것이 일반적이다.

### 사용자 정의 채널 그룹 생성

- 대부분의 경우, 스레드 수를 제한한 스레드풀 기반의 그룹을 만든다.
```java
AsynchronousChannelGroup channelGroup =
    AsynchronousChannelGroup.withFixedThreadPool(
        최대스레드수,
        Executors.defaultThreadFactory()
    );
```
- 또는 CPU 코어 수에 맞춰 자동으로 스레드 수를 조정할 수도 있다.
```java
AsynchronousChannelGroup channelGroup =
    AsynchronousChannelGroup.withFixedThreadPool(
        Runtime.getRuntime().availableProcessors(),
        Executors.defaultThreadFactory()
    );
```
- 이렇게 생성한 그룹은 이후 비동기 채널 생성 시 매개값으로 전달하여 사용한다.

### 채널 그룹 종료

- 비동기 채널 그룹은 더 이상 사용하지 않을 때 명시적으로 종료해야 한다.

```java
channelGroup.shutdown();
channelGroup.shutdownNow();
```
- shutdown()
  - 즉시 종료하지 않고, 종료 요청만 전달한다. 
  - 그룹 내의 모든 비동기 채널이 닫히면 자동으로 종료된다. 
  - 종료 요청 이후 새로운 채널을 추가하면 ShutdownChannelGroupException 발생.
  - 이미 제출된 I/O 작업은 계속 수행되지만, 새로운 작업은 거부된다.
- shutdownNow()
  - 강제 종료. 그룹 내 모든 비동기 채널을 즉시 닫는다. 
  - 단, 이미 콜백을 수행 중인 스레드는 종료되거나 인터럽트되지 않는다.

---

## 5. 비동기 서버소켓 채널

- `AsynchronousServerSocketChannel`은 비동기 방식으로 클라이언트의 연결 요청을 처리하는 서버 소켓 채널이다. 
- 이 객체는 두 가지 정적 메소드인 open()을 통해 생성할 수 있다.

### 생성 방법

#### 기본 비동기 채널 그룹 사용 

- 기본 그룹에 속하는 서버소켓채널을 얻으려면 매개변수 없는 open()을 호출한다.
```java
AsynchronousServerSocketChannel asynchronousServerSocketChannel = AsynchronousServerSocketChannel.open();
```
#### 사용자 정의 채널 그룹 사용

- 직접 만든 비동기 채널 그룹에 속하도록 하려면 다음과 같이 open(channelGroup)을 호출한다.
```java
AsynchronousChannelGroup channelGroup =
    AsynchronousChannelGroup.withFixedThreadPool(
        Runtime.getRuntime().availableProcessors(),
        Executors.defaultThreadFactory()
    );
AsynchronousServerSocketChannel asynchronousServerSocketChannel =
    AsynchronousServerSocketChannel.open(channelGroup);
```

### 포트 바인딩 및 종료

- 서버가 클라이언트의 요청을 수락하려면 포트를 바인딩해야 한다.
```java
asynchronousServerSocketChannel.bind(new InetSocketAddress(5001));
```
- 서버를 더 이상 사용하지 않을 경우에는 반드시 포트를 언바인딩해야 한다.
```java
asynchronousServerSocketChannel.close();
```

### 연결 수락 (accept)

- 연결 수락은 스레드풀을 통해 비동기적으로 처리된다.
- accept() 메소드의 형태는 다음과 같다.
```java
accept(A attachment, CompletionHandler<AsynchronousSocketChannel, A> handler);
// 첫 번째 매개값 (attachment): 콜백에 전달할 첨부 객체. 일반적으로 null 지정.
// 두 번째 매개값 (handler): 콜백 메소드(completed, failed)를 포함한 CompletionHandler 구현 객체.
```

#### 예시: 기본 수락 구조

```java
asynchronousServerSocketChannel.accept(null,
    new CompletionHandler<AsynchronousSocketChannel, Void>() {
        @Override
        public void completed(AsynchronousSocketChannel channel, Void attachment) {
            // 연결 수락 후 실행할 코드
            asynchronousServerSocketChannel.accept(null, this); // 다음 연결 대기
        }

        @Override
        public void failed(Throwable exc, Void attachment) {
            // 연결 수락 실패 시 실행할 코드
        }
    }
);
```
- 동작 요약
  - completed()
    - 연결이 성공하면 호출됨.
    - 첫 번째 매개값: 생성된 AsynchronousSocketChannel
    - 두 번째 매개값: 첨부 객체 (null)
    - 재호출을 통해 다음 연결 요청을 계속 받는다.
  - failed()
    - 연결 수락 중 예외 발생 시 호출. 
    - 첫 번째 매개값: 예외 객체 
    - 두 번째 매개값: 첨부 객체 (null)
  - 반복문으로 accept()를 계속 호출할 필요가 없다.
  - 대신 completed() 끝에서 accept()를 다시 호출하면 된다.

---

## 6. 비동기 소켓 채널

- AsynchronousSocketChannel 은 클라이언트와 서버 모두에서 사용되는 비동기 소켓 채널이다. 
  - 클라이언트 측: 서버로 연결 요청을 수행. 
  - 서버 측: AsynchronousServerSocketChannel이 클라이언트 연결을 수락하면 자동 생성.
- 서버가 생성한 AsynchronousSocketChannel은 서버와 동일한 비동기 채널 그룹에 속한다.

### 생성 방법

#### 기본 채널 그룹 사용
   
```java
AsynchronousSocketChannel asynchronousSocketChannel = AsynchronousSocketChannel.open();
```

#### 사용자 정의 채널 그룹 사용

```java 
AsynchronousChannelGroup channelGroup =
    AsynchronousChannelGroup.withFixedThreadPool(
        Runtime.getRuntime().availableProcessors(),
        Executors.defaultThreadFactory()
    );

AsynchronousSocketChannel asynchronousSocketChannel = AsynchronousSocketChannel.open(channelGroup);
```

#### 종료

- 더 이상 사용하지 않으면 반드시 닫아야 한다.
```java
asynchronousSocketChannel.close();
```

### 서버 연결 요청 (connect)

- 비동기 연결 요청은 스레드풀을 통해 처리되며, connect() 메소드의 형식은 다음과 같다.
```java
connect(SocketAddress remote, A attachment, CompletionHandler<Void, A> handler);
// remote: 서버의 IP 주소 및 포트 (InetSocketAddress)
// attachment: 콜백에 전달할 첨부 객체 (null 사용 가능)
// handler: 작업 완료 및 실패 시 호출될 CompletionHandler 객체
```

### 예시 코드

```java
asynchronousSocketChannel.connect(
    new InetSocketAddress("localhost", 5001),
    null,
    new CompletionHandler<Void, Void>() {
        @Override
        public void completed(Void result, Void attachment) {
            // 연결 성공 후 실행할 코드
        }

        @Override
        public void failed(Throwable e, Void attachment) {
            // 연결 실패 시 실행할 코드
        }
    }
);
```
- 동작 요약 
  - completed()
    - 연결이 성공하면 호출. 
    - 서버와 데이터 송수신 준비 완료. 
  - failed()
    - 연결 요청 중 예외 발생 시 호출. 
    - 예외 객체(Throwable)가 전달됨.

---

## 7. 비동기 소켓 채널의 데이터 통신

- 클라이언트와 서버가 연결된 상태에서 read()와 write() 메소드로 데이터를 송수신할 수 있다. 
- 모든 입출력은 스레드풀이 수행하며, 호출은 즉시 리턴된다.

### 메소드 형식
   
```java
read(ByteBuffer dst, A attachment, CompletionHandler<Integer, A> handler);
write(ByteBuffer src, A attachment, CompletionHandler<Integer, A> handler);
// ByteBuffer: 데이터 버퍼
// attachment: 콜백에 전달할 첨부 객체
// CompletionHandler: 작업 완료(completed) 및 실패(failed) 시 실행할 코드 포함
```

### read() 예시

```java
asynchronousSocketChannel.read(
    byteBuffer,
    attachment,
    new CompletionHandler<Integer, A>() {
        @Override
        public void completed(Integer result, A attachment) {
            // 받은 데이터 처리 코드
            // 다음 데이터 수신 대기
            asynchronousSocketChannel.read(byteBuffer, attachment, this);
        }

        @Override
        public void failed(Throwable exc, A attachment) {
            // 읽기 실패 처리 코드
        }
   }
);
```
- completed()
  - 읽기 완료 후 호출. 
  - result: 읽은 바이트 수 
  - attachment: 호출 시 사용된 첨부 객체
    - 추가 데이터를 받기 위해 read()를 다시 호출함.
- failed()
  - 읽기 도중 예외 발생 시 호출. 
  - 반복 루프로 read()를 계속 호출하지 않는다. 
  - 대신 completed() 내부에서 재호출하여 지속 수신한다.

### write() 예시

```java
asynchronousSocketChannel.write(
    byteBuffer,
    attachment,
    new CompletionHandler<Integer, A>() {
        @Override
        public void completed(Integer result, A attachment) {
            // 데이터 전송 성공 후 실행할 코드
        }

        @Override
        public void failed(Throwable exc, A attachment) {
            // 쓰기 실패 시 실행할 코드
        }
   }
);
```
- completed()
  - 쓰기 완료 시 호출. 
  - result: 전송된 바이트 수
- failed()
  - 쓰기 도중 예외 발생 시 호출.

---

### 참고자료

[이것이 자바다](https://search.shopping.naver.com/book/catalog/32473359191?query=%EC%9D%B4%EA%B2%83%EC%9D%B4%20%EC%9E%90%EB%B0%94%EB%8B%A4&NaPm=ct%3Dm7ne3c9k%7Cci%3D6356ea398110d474e244102192a893d910277fb2%7Ctr%3Dboksl%7Csn%3D95694%7Chk%3Da51fed5127109d9f5a3bd6af6be4725cd7500518)

[Java Docs - AsynchronousChannelGroup](https://docs.oracle.com/javase/8/docs/api/java/nio/channels/AsynchronousChannelGroup.html)

[Java Docs - AsynchronousSocketChannel](https://docs.oracle.com/javase/8/docs/api/java/nio/channels/AsynchronousSocketChannel.html)