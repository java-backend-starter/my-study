# JDBC

---

## 1. JDBC(Java Database Connectivity)란?

- 자바 어플리케이션이 데이터베이스(DB)와 연결해서 삽입, 조회, 수정, 삭제(CRUD)를 할 수 있게 해주는 표준 API다. 
-  DBMS 종류(MySQL, Oracle, PostgreSQL 등)에 상관없이 동일한 방식으로 접근 가능하다. 
- 구조적으로는 java.sql + javax.sql 패키지로 나뉜다. 
- java.sql엔 기본 인터페이스들이 있고, javax.sql엔 확장 기능들이 있다. 
- 각 DBMS는 이 인터페이스들을 구현한 드라이버(.jar 파일)를 제공한다. 
    - JDBC 인터페이스만 쓰면 되고, 뒤에서 DBMS별 드라이버가 실제 작업을 처리

---

## 2. JDBC 구성 요소

### 자바 표준 인터페이스 (java.sql, javax.sql)

- java.sql
    - JDBC의 기본 기능을 담당하는 인터페이스 집합. 
    - 예: Connection, Statement, ResultSet 등. 
- javax.sql
    - JDBC 기능을 확장하는 고급 인터페이스들. 
    - 예: DataSource, ConnectionPoolDataSource, RowSet 등. 

#### 주요 인터페이스 (java.sql 측)

- Driver
    - JDBC 드라이버가 구현해야하는 인터페이스. 
    - 드라이버 등록 & 연결 생성 기능 포함. 
- Connection
    - DB와의 연결을 나타내는 객체. 
    - SQL 실행 객체 생성, 트랜잭션 처리 가능. 
    - commit(), rollback(), close() 등의 메서드도 포함
- Statement
    - 가장 기본적인 SQL 실행용 인터페이스 
    - 정적 SQL 문을 실행할 떄 사용 
- PreparedStatement
    - Statement의 확장 인터페이스
    - 파라미터가 포함된 SQL 실행용
    - 보안(SQL 인젝션 방지)/성능 면에서 우수. 
- CallableStatement
    - 저장 프로시저 또는 DB 함수 호출용. 
- ResultSet
    - SELECT 질의 결과를 다루는 객체. 
    - 행 단위로 데이터를 읽을 수 있고 커서 단위 탐색 가능. 

#### 확장 인터페이스 (javax.sql 측)

- DataSource
    - DriverManager를 대체하는 연결 팩토리 인터페이스
    - 애플리케이션 서버나 프레임워크(Spring, JPA 등)에서 주로 사용
    - 커넥션 풀 및 트랜잭션 매니저와 쉽게 통합
    - DataSource를 사용하는 방식이 표준
- ConnectionPoolDataSource
    - 커넥션 풀링을 위한 인터페이스
    - 하나의 커넥션이 사용 후 반환되어 재사용되도록 설계되어 있어, 고성능 서버 환경에 적합
    - 실제 풀링 구현체(HikariCP, DBCP 등)는 이 인터페이스를 기반으로 구현
    - 개발자가 직접 사용할 일은 거의 없으며, 풀 관리자가 내부에서 사용
- PooledConnection
    - ConnectionPoolDataSource가 생성한 커넥션 객체
    - 커넥션 풀 내부에서 물리적인 DB 연결을 직접 관리하는 객체이며, 커넥션 풀 관리자에 의해 사용
    - 사용자 코드에서는 거의 접근하지 않는다.
- RowSet 계열
    - ResultSet의 확장 개념으로, 더 유연하고 독립적인 데이터 처리 인터페이스
    - ResultSet과 달리 스스로 DB에 연결할 수 있고, 직렬화/오프라인 처리가 가능
    - 주요 하위 타입:
        - JdbcRowSet: 연결형 RowSet, ResultSet과 비슷하게 사용 가능
        - CachedRowSet: 비연결형 RowSet, 네트워크 없이 사용 가능 (오프라인 처리)
        - WebRowSet: XML 기반 RowSet, 웹 애플리케이션에 적합

### JDBC 드라이버

#### 개념

- JDBC 드라이버는 자바 프로그램과 특정 DBMS 사이의 통신 담당자
- 각 DBMS는 java.sql, javax.sql 인터페이스를 구현한 .jar 파일 형태로 드라이버를 제공
- 개발자는 JDBC 인터페이스만 사용하고, 실제 작업(연결, SQL 전송, 결과 처리)은 전부 드라이버 구현체가 처리

#### 드라이버의 역할

- JDBC 표준 인터페이스(Connection, Statement, ResultSet 등)의 구현체 제공
- DBMS와 실제로 SQL을 주고받고, 실행 결과를 자바 객체 형태로 전달
- Class.forName(...) 같은 방법으로 직접 로딩하거나, 환경에 따라 자동 로딩되기도 한다
- 드라이버 없이는 자바가 DB와 아예 통신할 수 없다.

#### DBMS별 JDBC 드라이버

- MySQL : mysql-connector-j
- Oracle : ojdbc8, ojdbc11
- PostgreSQL : postgresql-<version>.jar
- MariaDB : mariadb-java-client
- SQL Server : mssql-jdbc
- SQLite : sqlite-jdbc

---

## 3. JDBC 사용 핵심

- 개발자는 인터페이스만 사용하고, 실제 동작(드라이버 구현체)은 드라이버가 책임진다. 
- 다형성(polymorphism)의 활용
    - 예를 들어 Connection conn = DriverManager.getConnection(...) 형태의 코드를 작성해도 실제로는 MySQL 드라이버 내부구현체(com.mysql.cj.jdbc.ConnectionImpl 등)가 사용된다. 
- DBMS 변경 시 코드 대부분 변경 없이 드라이버만 바꾸면 되는 구조

---

## 4. JDBC 사용 흐름

![JDBC 사용 흐름](https://velog.velcdn.com/images/artp/post/b986ad60-d823-47f5-b0dc-71ec0a635906/image.png)

### 드라이버 로딩

- 예: `Class.forName("com.mysql.cj.jdbc.Driver");` 
- 자바 프로그램이 사용할 JDBC 드라이버 클래스(.jar 파일 내부)를 메모리에 로드
- 이 클래스는 내부적으로 java.sql.Driver 인터페이스를 구현하고, 로딩될 때 DriverManager에 자동 등록
- 자바 6 이상부터는 자동으로 로드되는 경우가 많다.

### DB 연결 생성

- `Connection conn = DriverManager.getConnection("jdbc:mysql://localhost:3306:mydb", "user", "password");`
- DriverManager는 로딩된 드라이버 중 URL에 맞는 드라이버를 찾아서 연결을 시도
    - 연결에 성공하면 DB와의 세션(Session)을 나타내는 Connection 객체를 반환
- URL 구성 기본: jdbc:mysql://호스트:포트/DB이름?옵션 등. 
- 예외: 연결 실패 시 SQLException 발생. 

### SQL 실행 객체 생성

- 정적 SQL: `Statement stmt = conn.createStatement();`
- 동적 SQL(파라미터 포함): `PreparedStatement ps = conn.prepareStatement("SELECT * FROM customer WHERE id = ?"); ps.setInt(1, 101);` 

### SQL 실행

- SELECT 문: `ResultSet rs = ps.executeQuery();`
    - 결과는 ResultSet 객체로 반환
    - 행(row) 단위로 탐색 가능
- INSERT/UPDATE/DELETE 문: `int result = ps.executeUpdate();`
    - 반영된 행(row)의 수를 반환

### 결과 처리

- 예
```java
while (rs.next()) {
    String name = rs.getString("name");
    int age = rs.getInt("age");
}
```
- 주요 메서드


|메서드|	설명|
|:---:|:---:|
|next()|	다음 행으로 이동 (없으면 false 반환)|
|getString("컬럼명")	|문자열 반환|
|getInt(1)	|첫 번째 컬럼의 정수값 반환|
|getDate(...), getDouble(...) 등	|다양한 타입 지원|

### 자원 정리 (Close)

- `rs.close(); ps.close(); conn.close();` 
- JDBC의 자원 누수를 방지하기 위해 반드시 명시적으로 close() 호출이 필요
    - 사용한 순서의 역순으로 닫는 것이 안전합니다.
- Java 7 이상부터는 try-with-resources 구문 사용 권장
    - AutoCloseable 인터페이스 덕분에 자원을 자동으로 닫아준다

### 흐름 요약

- 드라이버 로딩 → DB 연결 → SQL 실행 객체 생성 → SQL 실행 → 결과 처리 → 자원 해제 

---

## 5. Driver vs DriverManager

### Driver

- 인터페이스 java.sql.Driver. 드라이버 개발자가 구현해야 하는 규약. 
- 주요 역할: URL을 처리할 수 있는지 확인(acceptsURL), 실제 DB 연결 생성(connect), 드라이버 정보 제공 등. 
- 개발자가 직접 사용하는 일이 거의 없음(객체 생성이나 메서드 호출)이다. 

### DriverManager

- 클래스 java.sql.DriverManager. 개발자가 직접 사용하는 주체. 
- 예: `DriverManager.getConnection(...)`
- 역할: 등록된 여러 드라이버 중에서 적합한 드라이버를 선택하고, 그 드라이버를 통해 연결을 생성. 

### DriverManager는 Driver를 "선택하고 위임"한다

- 흐름 요약:
    - 드라이버 클래스 로딩 (Class.forName(...)) → 드라이버 등록됨. 
    - DriverManager.getConnection(...) → URL에 맞는 드라이버 찾음 → connect(...) 호출 → 실제 연결 생성. 
- MySQL 드라이버 예시: Driver 클래스 내부 static 블록에서 DriverManager.registerDriver(new Driver()); 호출됨. 

### 비교 정리 표


---

## 6. JDBC 흐름 정리

- 단계 1: 드라이버 로딩 → Class.forName()
    - 특정 DBMS(MySQL, Oracle 등)용 JDBC 드라이버 클래스를 JVM에 로딩
    - 클래스 로딩 시, 드라이버의 static 블록이 실행되어 DriverManager에 자동 등록
- 단계 2: DB 연결 생성 → DriverManager.getConnection()
    - DriverManager가 URL에 맞는 드라이버를 선택해 DB 연결을 생성
    - 이때 필요한 정보:
        - url: DBMS 종류, 호스트, 포트, DB이름
        - user, password: 계정 정보
- 단계 3: SQL 실행 객체 생성 → createStatement() 또는 prepareStatement()
    - 정적 SQL: Statement
    - 동적 SQL(파라미터 포함): PreparedStatement 사용 권장 (보안, 성능 측면에서 우수)
- 단계 4: SQL 실행 → executeQuery() (SELECT) 또는 executeUpdate() (변경)
    - executeQuery() → 결과 집합(ResuletSet) 반환 (SELECT 용)
    - executeUpdate() → 영향 받은 행의 수 반환 (INSERT, UPDATE, DELETE 용)
    - ResultSet은 테이블 형식의 결과로, 커서는 처음에 첫 행 이전에 위치
        - rs.next()를 호출해야 첫 행으로 이동됨
        - 컬럼 인덱스는 1부터 시작
- 단계 5: 결과 처리 → rs.next(), getString(), getInt() 등
```java
// 여러 행인 경우
while (rs.next()) {
    System.out.println(rs.getString("name"));
}

// 결과가 1행만 있는 경우
if (rs.next()) {
    System.out.println(rs.getString("name"));
}
```
- 단계 6: 자원 해제 → close() 순서대로
    - 사용한 JDBC 객체는 반드시 close() 해줘야 한다.
    - 생성한 순서의 역순으로 닫는 것이 원칙 (ResultSet → Statement → Connection)
    - Java 7 이상에서는 try-with-resources 사용 가능

---

### 출처

[JDBC](https://velog.io/@artp/Java-JDBC)