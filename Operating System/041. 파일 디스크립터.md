# 파일 디스크립터

---

## 1. 개요

- 파일 디스크립터(File Descriptor)는 프로세스가 커널에 요청한 자원(파일, 소켓, 파이프 등)을 식별하기 위한 비음수 정수값이다.
- 커널 내부의 파일 테이블(file table) 엔트리를 가리키는 인덱스 역할을 한다.
- 프로세스는 파일 디스크립터를 통해 간접적으로 커널 자원에 접근한다.

---

## 2. 전체 구조 흐름

```
[프로세스]
 └── File Descriptor Table
       └── File Descriptor (정수값, 예: 3)
             └── File Table Entry (파일 포인터, 오프셋, 접근 모드 등)
                   └── inode 구조체 (디스크의 메타데이터, 위치 등)
```
- FD는 사용자/프로세스 관점의 핸들
- 파일 테이블은 커널에서 열린 파일의 상태를 관리하는 핵심 구조
- inode는 디스크 상 실제 파일 메타데이터 정보

### 구성 요소 설명

#### 파일 디스크립터 (FD)

- `open()` 시스템 콜이 성공하면 반환되는 정수값
- 프로세스별 FD 테이블에서 파일 테이블을 참조함

#### 파일 디스크립터 테이블 (FD Table)

- 프로세스마다 존재
- 각 FD는 파일 테이블의 포인터를 가짐
- `dup()`, `fork()` 등을 통해 공유 가능

#### 파일 테이블 (File Table)

- 커널 전역에 존재 (모든 프로세스가 공유)
- 열린 파일마다 1개씩 존재
- 정보
    - 파일의 현재 오프셋
    - 접근 모드 (읽기/쓰기/append 등)
    - 파일 상태 플래그
    - 연결된 inode 포인터

#### inode 구조체

- 실제 파일의 메타데이터 (파일 크기, 위치, 권한 등)

---

## 3. 기본 파일 디스크립터

| 번호 | 이름   | 설명            |
|------|--------|-----------------|
| 0    | stdin  | 표준 입력       |
| 1    | stdout | 표준 출력       |
| 2    | stderr | 표준 에러 출력  |

---

## 4. 주요 시스템 호출

```c
int fd = open("file.txt", O_RDONLY); // 파일 열고 FD 반환
read(fd, buf, size);                 // FD로부터 읽기
write(fd, buf, size);                // FD에 쓰기
close(fd);                           // FD 해제
```

---

## 5. 고급 기능 및 확장

- `dup()`, `dup2()`
    - FD 복제 (리디렉션 구현 등에 사용)
    - 같은 파일 테이블 엔트리 참조 → 오프셋 공유
- `pipe(fd[2])`: 익명 파이프 생성
- `select()`, `poll()`, `epoll()`
    - 여러 FD를 동시에 감시 (네트워크/비동기 처리)
- `fcntl(fd, F_GETFD)`: FD 속성 조회/설정

---

## 6. 실전 예시

### 예시: 하나의 파일을 두 프로세스가 열 경우

- 각 프로세스는 고유 FD 테이블을 가짐
- 동일 파일을 열면 파일 테이블 엔트리는 별도로 생성됨

### 예시: `fork()` 사용

- 자식 프로세스는 부모의 FD 테이블을 복사함
- 같은 파일 테이블 엔트리를 참조 → 오프셋 공유

---

## ✅ 자주 발생하는 이슈

- FD 누수 (leak)
    - `close()` 호출 안 할 경우 리소스가 해제되지 않음 → `Too many open files` 오류
- FD 제한
    - 프로세스당 열 수 있는 FD 수는 제한적 (`ulimit -n`으로 확인 가능)
- 동기화 이슈
    - 다중 프로세스/스레드가 동일 FD를 공유할 경우 오프셋 충돌 가능

---

### 참고 자료

ChatGPT 질의 : 파일 디스크립터에 대한 정리

[man7.org (영문 매뉴얼)](https://man7.org/linux/man-pages/dir_section_2.html)
