# 교착상태 예방법

---

## 1. 교착 상태 해결 방법

- 교착 상태는 시스템 자원 관리에서 발생할 수 있는 심각한 문제이며, 이를 해결하기 위한 대표적인 방법은 다음 네 가지이다:

| 해결 방법            | 개념                                                                 | 장점                                           | 단점                                                                 |
|---------------------|----------------------------------------------------------------------|------------------------------------------------|----------------------------------------------------------------------|
| 예방 (Prevention)   | 교착 상태의 4가지 조건(상호 배제, 점유와 대기, 비선점, 원형 대기) 중 하나 이상이 성립되지 않도록 시스템을 설계 | 이론적으로 교착 상태 발생 불가                | 시스템 자원의 활용도가 떨어지며, 유연성이 크게 저하됨             |
| 회피 (Avoidance)    | 시스템의 상태를 감시하며, 교착 상태가 발생하지 않도록 자원을 신중하게 할당 (ex. 은행가 알고리즘) | 교착 상태를 예방하면서도 일부 유연성 유지     | 자원의 최대 요구량을 미리 알아야 하며, 계산 비용이 큼              |
| 검출 (Detection)    | 교착 상태 발생을 허용하고, 자원 할당 그래프 등을 통해 이를 탐지         | 시스템 자원을 최대한 활용 가능                | 교착 상태가 발생한 후 대응해야 하므로, 피해 발생 가능             |
| 회복 (Recovery)     | 교착 상태가 검출된 후, 이를 해결하기 위해 프로세스를 종료하거나 자원을 선점 | 실제 발생한 교착 상태에만 대응하므로 효율적   | 데이터 손실 위험, 프로세스 종료 등의 부작용 발생 가능             |

- 예방은 원천 봉쇄지만, 비효율적임. 
- 회피는 지능적인 자원 관리지만, 복잡하고 제한적임. 
- 검출과 회복은 실질적이며 현실적인 방식이나, 대응 과정에서 비용과 위험이 수반됨. 
- 이 네 가지 방식은 각각의 상황과 시스템 특성에 따라 선택적으로 사용되며, 현실적인 운영체제에서는 보통 '검출과 회복' 전략이 자주 채택된다.

---

## 2. 교착 상태 예방

- 교착 상태를 유발하는 네 가지 조건 중 하나라도 발생하지 않도록 막아 교착 상태를 처리하는 방법
- 자원을 보호하기 위해 상호 배제와 비선점을 예방하기 어려우며 점유와 대기, 원형 대기는 프로세스 작업 방식을 제한하고 자원을 낭비하기 때문에 사용할 수 없다.

| 예방 기법         | 개념 요약                                                               | 장점                                                    | 단점                                                                                 |
|-------------------|------------------------------------------------------------------------|---------------------------------------------------------|--------------------------------------------------------------------------------------|
| 상호 배제 예방     | 독점 자원을 없애고 모든 자원을 공유 가능하게 함                         | 교착 상태의 근본 원인 중 하나 제거 가능                 | 현실적으로 모든 자원을 공유할 수 없음 (프린터, 임계구역 등은 공유 불가)            |
| 비선점 예방        | 자원을 언제든지 빼앗을 수 있도록 설정                                    | 자원 점유로 인한 교착 상태 예방 가능                    | 임계구역 보호 불가, 자원 강탈 기준 설정 어려움, 아사 현상 유발 가능                |
| 점유와 대기 예방   | 필요한 모든 자원을 한 번에 할당하거나 하나도 할당하지 않음              | 프로세스의 자원 요청 방식 변화로 교착 상태 예방 가능    | 자원 낭비, 자원 정보 파악 어려움, 아사 현상, 일괄 처리 방식으로 시스템 비효율 초래  |
| 원형 대기 예방     | 자원에 순서를 부여하고 번호 순서대로만 자원 요청 가능                    | 비교적 유연한 방식으로 교착 상태 예방 가능              | 자원 사용 순서 제약, 번호 부여 문제, 사용자 입장에서 비직관적인 자원 요청 거부 발생 |

---

## 3. 교착 상태 회피

### 개념

- 정의: 자원을 어느 수준 이상 할당하면 교착 상태가 발생할 수 있기 때문에, 그 이하로만 자원을 할당하여 교착 상태를 피하는 방식.
- 특징
    - 예방 방식보다 유연함.
    - 시스템 운영 방식의 변경 없이 자원 수 조절로 교착 상태 회피.
- 안정 상태(Safe State): 모든 프로세스가 자원을 할당받아 종료될 수 있는 상태.
- 불안정 상태(Unsafe State): 교착 상태가 발생할 가능성이 있는 상태. 반드시 발생하는 것은 아님.
- 예시: 자원이 많을수록 불안정 상태가 커지고, 자원이 적을수록 안정 상태가 커짐.

### 은행원 알고리즘

- 정의: 데이크스트라가 제안한 알고리즘. 은행이 대출을 허용하는 원칙에서 착안.
- 비유: 음식 재료가 정해져 있는 레스토랑에서 주문 상황을 최악의 경우로 가정하여 예약을 제한하는 방식.

#### 핵심 변수

| 변수        | 설명                                                    |
|-------------|---------------------------------------------------------|
| Max         | 각 프로세스가 필요로 하는 최대 자원 수                 |
| 할당 자원    | 현재 프로세스에 할당된 자원 수                          |
| 기대 자원    | `Max - 할당 자원`                                      |
| 가용 자원    | 시스템 전체 자원 수에서 모든 할당 자원을 뺀 값         |

#### 자원 할당 기준

1. 가용 자원이 기대 자원 이상인 프로세스가 있다면 → 자원 할당 (안정 상태)
2. 가용 자원이 어떤 기대 자원보다 작다면 → 자원 미할당 (불안정 상태)

#### 예시

- 전체 자원: 14개
- 현재 할당: P1(2), P2(4), P3(6) → 총 12개 사용, 가용 자원: 2개
- 기대 자원: P1(3), P2(2), P3(4)
  - P2에 2개 할당 → 종료 후 자원 반납 → P1 또는 P3 작업 가능 → 안정 상태   
  - P1이나 P3에 자원 할당 → 기대 자원 충족 불가 → 작업 불가 → 불안정 상태

### 교착 상태 회피의 문제점

1. 자원 선언의 어려움
    - 모든 프로세스가 사용할 자원을 미리 정확히 선언해야 함.
    - 부정확한 선언은 회피 실패로 이어질 수 있음.
2. 고정 자원 수 필요
    - 시스템 자원이 고정되어 있어야 정확한 회피가 가능.
    - 현실에선 자원의 추가/고장이 빈번해 불가능.
3. 자원 낭비
    - 실제로는 문제가 없는 경우에도 자원 할당을 제한해 낭비 발생.
    - 예: 최대 자원을 사용하지 않고 종료되는 프로세스가 있을 수 있음.

---

## 4. 교착 상태 검출

### 개념

- 교착 상태 예방은 구현이 어려우며, 교착 상태 회피는 자원 낭비를 초래할 수 있습니다. 
- 가장 현실적인 방법은 교착 상태 검출로, 운영체제가 프로세스 작업을 관찰하고 교착 상태 발생 여부를 계속 확인합니다. 
- 교착 상태가 발견되면 이를 해결하기 위한 회복 단계를 밟습니다.

#### 타임아웃을 이용한 교착 상태 검출

- 타임아웃 방식은 일정 시간 동안 작업이 진행되지 않은 프로세스를 교착 상태로 간주하고 처리하는 방법입니다. 
- 교착 상태가 드물게 발생한다고 가정하고 사용되며, 간단히 구현할 수 있습니다. 
- 예시: 윈도우에서 "프로그램이 응답이 없어 종료합니다" 메시지.
- 문제점 
  - 엉뚱한 프로세스 종료: 교착 상태 외의 다른 이유로 작업이 진행되지 않은 프로세스도 강제 종료될 수 있습니다. 
  - 분산 시스템에 적용 어려움: 네트워크 문제 등으로 원격 프로세스가 응답하지 않는 경우 교착 상태를 판별하기 어려운 문제도 있습니다.
- 타임아웃은 가벼운 교착 상태 검출 방식이며, 자원 할당 그래프를 이용한 방법은 무거운 교착 상태 검출 방식입니다. 타임아웃 방식이 선호되는 이유는 구현이 간단하기 때문입니다.

#### 데이터베이스에서의 타임아웃 처리

- 데이터베이스에서는 체크포인트와 롤백을 사용하여 타임아웃으로 인한 데이터 일관성 문제를 해결합니다. 
  - 체크포인트: 시스템 상태를 저장하여 문제가 발생하면 그 시점으로 복구할 수 있습니다. 
  - 롤백: 체크포인트로 돌아가서 시스템을 이전 상태로 복구합니다.

#### 자원 할당 그래프를 이용한 교착 상태 검출

- 자원 할당 그래프는 시스템 내의 프로세스가 자원을 어떻게 사용하고 있는지를 나타내는 그래프입니다. 사이클이 발견되면 교착 상태가 발생했다고 판단합니다.
- 예시
  - 교착 상태가 없는 자원 할당 그래프: 프로세스들이 자원을 순차적으로 기다리며 사이클이 없는 경우, 교착 상태가 발생하지 않습니다. 
  - 교착 상태가 있는 자원 할당 그래프: 사이클이 존재하면 교착 상태가 발생한 것으로 판단합니다. 
- 주의: 단일 자원을 사용하는 경우 사이클이 있으면 교착 상태로 판단하지만, 다중 자원을 사용하는 경우에는 교착 상태가 아닐 수도 있습니다.

##### 장점과 단점

- 장점: 자원 할당 그래프는 교착 상태를 정확히 파악할 수 있으며, 프로세스의 작업 방식을 제한하지 않습니다. 
- 단점: 그래프를 유지하고 갱신하며 사이클을 검사하는 데 추가적인 오버헤드가 발생합니다. 
- 이를 해결하기 위해 일정 시간마다 사이클 검사를 할 수도 있습니다.

---

## 5. 교착 상태 회복

- 교착 상태가 검출되면 이를 해결하는 후속 작업을 교착 상태 회복이라고 한다.
- 주요 방식은 교착 상태를 일으킨 프로세스를 강제로 종료하는 것입니다.

### 교착 상태 회복 방법

1. 교착 상태를 일으킨 모든 프로세스를 동시에 종료
   - 방법: 교착 상태를 일으킨 모든 프로세스를 한 번에 종료합니다. 
   - 문제점: 종료된 프로세스들이 다시 동시에 실행되면 교착 상태가 다시 발생할 가능성이 높습니다. 따라서, 종료 후 프로세스를 순차적으로 실행해야 하며, 이때 어떤 프로세스를 먼저 실행할지에 대한 기준이 필요합니다.
2. 교착 상태를 일으킨 프로세스 중 하나를 선택해 순서대로 종료
   - 방법: 교착 상태를 일으킨 프로세스 중 하나를 선택하여 순차적으로 종료하며, 나머지 프로세스의 상태를 확인합니다. 
   - 우선순위 기준:
     - 우선순위가 낮은 프로세스를 먼저 종료합니다. 
     - 우선순위가 같은 경우, 작업 시간이 짧은 프로세스를 먼저 종료합니다. 
     - 우선순위와 작업 시간이 같은 경우, 자원을 많이 사용하는 프로세스를 먼저 종료합니다.
3. 시스템 복구
   - 교착 상태 회복 시, 강제 종료된 프로세스가 실행되기 전에 시스템을 복구해야 합니다. 
   - 복구 방법: 명령어가 실행될 때마다 체크포인트를 만들어 최근의 검사 시점으로 돌아갑니다. 
   - 문제점: 체크포인트를 자주 사용하면 시스템에 부하를 줄 수 있으므로 선택적으로 사용해야 합니다.

---

### 참고자료

[쉽게 배우는 운영체제](https://product.kyobobook.co.kr/detail/S000001743685)