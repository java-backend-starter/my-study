# 스와핑

---

## 1. 요구 페이징

- 요구 페이징은 프로세스가 필요로 하는 데이터를 언제 메모리로 가져올지 결정하는 방법이다.
- 일반적으로 프로세스가 데이터를 요청할 때 메모리로 가져오는 방식이다.

### 요구 페이징의 개요

- 컴퓨터를 오랫동안 사용하다 보면 시스템 속도가 느려지게 된다. 
- 이는 작업을 하지 않는 프로세스나 좀비 프로세스가 메모리를 차지하여 메모리 관리가 복잡해지기 때문이다. 
- 따라서 메모리에는 필요한 프로세스만 유지하는 것이 효율적이다.
- 목적:
    - 메모리 효율적 관리: 메모리가 가득 차면 관리가 어려워지므로, 적은 양의 프로세스만 메모리에 올린다.
    - 응답 속도 향상: 대형 프로그램을 모두 메모리에 올리면 시스템 응답이 느려질 수 있기 때문에 필요한 모듈만 메모리에 올린다.

### 예시

- 포토샵과 같은 대형 프로그램을 실행할 때, 본 프로그램만 메모리에 올린다.
  - 외부 필터 같은 다른 모듈은 사용자가 요청할 때마다 메모리로 가져오는 방식이 효율적이다. 
- 이 방식은 메모리 절약, 효율적인 관리, 응답 속도 향상의 장점이 있다.

### 요구 페이징 vs 미리 가져오기

- 요구 페이징
  - 사용자가 필요할 때 해당 페이지를 메모리로 가져온다.
- 미리 가져오기
  - 예상되는 페이지를 미리 메모리로 가져오는 방식으로, 대표적인 예는 캐시이다. 
  - 하지만 예상과 다른 데이터를 미리 가져오면 시스템에 불필요한 부담을 줄 수 있다. 
  - 현대 운영체제는 요구 페이징을 기본으로 사용한다.

### 스와핑과 게으른 스와퍼

- 순수한 스와핑
  - 프로세스 전체를 메모리에서 디스크로 내보내거나, 디스크에서 다시 통째로 메모리로 불러오는 방식이다. 
  - 이는 과거 운영체제에서 사용되었으며, 현대에는 페이지 단위 스와핑이 일반적이다.
- 게으른 스와퍼
  - 프로세스 전체를 한꺼번에 메모리에 올리는 것이 아니라 필요할 때마다(실제 페이지 부재 발생 시점) 개별 페이지를 메모리에 올리는 방식이다.
  - 요구 페이징의 형태이다.

---

## 2. 페이지 테이블 엔트리의 구조

### 가상 메모리와 스왑 영역

- 가상 메모리: 물리 메모리와 스왑 영역(하드디스크)을 합친 것이다.
- 스왑 영역: 물리 메모리가 부족할 때 데이터를 하드디스크로 내보내는 공간이다.
- 스왑인: 스왑 영역에서 데이터를 물리 메모리로 가져오는 작업. 
- 스왑아웃: 물리 메모리에서 데이터를 스왑 영역으로 내보내는 작업. 
- 페이지 테이블은 각 페이지가 물리 메모리에 있는지, 스왑 영역에 있는지 표시해야 하며, 이를 유효 비트로 구분.

### 페이지 테이블 엔트리(PTE)의 구조

- PTE는 페이지 테이블의 한 행으로, 다음과 같은 구성 요소가 있다:
  - 페이지 번호: 가상 주소에서 해당 페이지를 식별하는 번호. 
  - 프레임 번호: 페이지가 물리 메모리의 어떤 프레임에 위치하는지 나타내는 번호. 
  - 플래그 비트: 여러 제어 비트로 구성.

### 주요 플래그 비트

#### 접근 비트 (Access Bit)

- 페이지가 메모리에 올려졌을 때 사용된 여부를 나타내는 비트. 
- 읽기나 실행 작업을 했으면 접근 비트가 1로 설정된다..

#### 변경 비트 (Modified Bit)

- 페이지가 메모리에 올라온 후 데이터가 변경되었는지를 나타내는 비트. 
- 페이지에 쓰기 작업을 했으면 변경 비트가 1로 설정된다. 이를 더티 비트 (Dirty Bit)라고도 한다.
- 이는 페이지가 스왑아웃될 때 중요한 정보를 제공한다.

#### 유효 비트 (Valid Bit)

- 페이지가 실제 메모리에 존재하는지, 즉 물리 메모리나 스왑 영역에 존재하는지 나타내는 비트. 
- 페이지가 메모리에 없고 스왑 영역에 있을 때 유효 비트가 0으로 설정됨. 이 비트는 현재 비트 (Present Bit)라고도 불림.

#### 읽기, 쓰기, 실행 비트 (Read, Write, Execute Bits)

- 페이지에 대한 읽기, 쓰기, 실행 권한을 나타내는 비트. 
- 권한이 없는 프로세스가 해당 권한으로 작업하려고 할 때 접근을 차단한다. 
- 세 가지 비트는 접근 권한 비트 (Rights Bit)라고도 한다.

#### 비트들의 역할

- 접근 비트와 변경 비트는 페이지가 메모리에 올라온 후 어떤 작업이 있었는지를 기록한다. 
- 이 비트들은 페이지를 스왑 영역으로 옮길 때 어떤 페이지를 선택할지 결정하는 데 사용된다.

---

## 3. 페이지 부재 (Page Fault)

### 유효 비트와 주소 필드

| 유효 비트 값 | 페이지 위치                          | 주소 필드 내용             |
|--------------|---------------------------------|-----------------------------|
| 0            | 물리 메모리에 있음                      | 물리 메모리의 프레임 번호   |
| 1            | 스왑 영역에 있음(페이지가 물리 메모리에 존재하지 않음) | 스왑 영역의 주소            |


### 페이지 부재란?
   
- 프로세스가 요청한 페이지가 물리 메모리에 없는 경우. 
- 페이지 테이블에서 해당 페이지의 유효 비트가 1 → 스왑 영역에 존재. 
- 이때 스왑인 작업을 통해 페이지를 메모리로 가져와야 함.

### 페이지 부재 처리 과정
   
- 프로세스가 메모리에 없는 페이지 요청 → 페이지 부재 발생 
- 스왑 영역에서 해당 페이지를 읽고 물리 메모리의 빈 프레임에 적재한다.

### 페이지 테이블 갱신

- 유효 비트: 1 → 0 
- 주소 필드: 스왑 주소 → 프레임 번호 
- 프로세스는 새로 적재된 페이지에 접근 가능

### 메모리가 꽉 찬 경우 - 페이지 교체

- 물리 메모리에 빈 프레임이 없을 경우
  - 페이지 교체 알고리즘을 통해 대상 페이지(Victim Page) 선택 
  - 선택된 페이지를 스왑 영역으로 스왑아웃 
  - 빈 공간에 요청한 페이지 스왑인 
  - 관련된 두 PTE를 모두 갱신

### 페이지 부재 vs 세그먼테이션 오류

| 구분           | 페이지 부재                          | 세그먼테이션 오류                    |
|----------------|--------------------------------------|------------------------------|
| 발생 원인      | 요청한 페이지가 메모리에 없음         | 잘못된(프로세스가 허용되지 않은) 메모리 영역 접근 |
| 주체           | 시스템 레벨 오류 (정상 작동)          | 사용자 프로세스의 잘못된 접근             |
| 처리 방식      | 페이지를 메모리로 스왑인              | 프로세스 강제 종료                   |

---

## 4. 지역성(Locality)

### 지역성이란?
   
- 메모리 접근이 전체적으로 분산되지 않고, 특정 영역에 집중되는 성질. 
- 페이지 교체 시 자주 사용되지 않을 페이지를 쫓아내야 성능 향상 가능. 
- 지역성은 페이지 교체 알고리즘의 기반이 됨.

### 지역성의 종류

| 종류                     | 설명                                                 | 비유                           |
|--------------------------|------------------------------------------------------|--------------------------------|
| 공간의 지역성 (Spatial Locality)  | 현재 접근 중인 위치 근처의 데이터도 곧 접근될 확률이 높음    | 집 가까운 편의점에 자주 감     |
| 시간의 지역성 (Temporal Locality) | 최근에 접근한 데이터는 다시 사용될 가능성이 높음             | 어제 산 CD를 오늘도 듣는다     |
| 순차적 지역성 (Sequential Locality) | 작업이 순차적으로 이루어지는 경향                           | 프로그램 코드가 순서대로 실행됨 |
- 순차적 지역성은 공간적 지역성의 특별한 경우로 보기도 함.

### 활용 예시: 캐시와 지역성

- 캐시 메모리는 지역성을 활용하여 자주 사용될 데이터를 미리 로드.
- goto 문 사용 지양 → 지역성에 어긋나기 때문.

### 지역성과 페이지 교체 알고리즘
   
- 페이지 교체 시, 앞으로 자주 사용될 가능성이 낮은 페이지를 선택해야 효율적. 
- 지역성 기반 예측을 통해 페이지 부재를 줄이고 시스템 성능 향상 가능. 
- 자주 사용하는 페이지를 내보내면 다시 불러와야 하므로 성능 저하 발생.

---

### 참고자료

[쉽게 배우는 운영체제](https://product.kyobobook.co.kr/detail/S000001743685)