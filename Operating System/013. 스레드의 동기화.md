# 스레드의 동기화세

---

## 1. 스레드 동기화의 필요성

###  동기화의 필요성

- 다수의 스레드가 동시에 공유 데이터에 접근하면 데이터 훼손 발생.
- 스레드 동기화(Thread Synchronization): 스레드들이 충돌 없이 공유 데이터에 안전하게 접근하도록 협력하는 기법.

### 공유데이터 접근 문제의 해결책

- 한 스레드가 공유 데이터 접근을 완료할 때까지 다른 스레드는 접근하지 못하도록 제어.
- 멀티 스레드 환경에서 경쟁 상황이 자주 발생.
- 특히 커널 내 공유 데이터가 많고, 다중 코어에서 더 주의가 필요함.

### 임계 구역과 상호 배제

- 임계 구역(Critical Section): 공유 데이터에 접근하는 코드 영역.
- 상호 배제(Mutual Exclusion): 한 시점에 하나의 스레드만 임계 구역에 진입하도록 보장.

---

## 2. 상호 배제 (Mutual Exclusion)

### 상호 배제를 포함하는 프로그램

- 일반 코드: 공유 데이터를 접근하지 않는 부분.
- 임계 구역 진입 코드: 다른 스레드의 임계 구역 진입 여부 확인, 없으면 락.
- 임계 구역 코드: 실제 공유 데이터를 접근하는 부분.
- 임계 구역 진출 코드: 진입 시 락을 해제하는 부분.

### 상호배제 구현

- 목표: 임계 구역에 단 하나의 스레드만 진입.
- 소프트웨어 방식: Peterson 알고리즘.
- 하드웨어 방식: 인터럽트 금지, 원자적 명령 사용.

### 인터럽트 서비스 금지 구현

- 진입 코드에서 CPU의 인터럽트를 막음.
- 단점: 모든 인터럽트를 무시하고, 멀티코어 시스템에서는 효과 없음.

### 단순 Lock 변수

- Lock 변수로 진입 제어.
- 문제점: Lock 변수 검사와 변경 사이 컨텍스트 스위칭 발생 시 실패 가능.

### 원자 명령 사용

- TSL (Test and Set Lock) 사용: 읽기-쓰기 명령을 원자적으로 처리.
- 안정적인 상호 배제 가능.

---

## 3. 멀티스레드 동기화 기법

### 기본

- 동기화 프리미티브: Lock 방식 / Wait-Signal 방식

### 뮤텍스 (Mutex) - Lock 방식

- 락 변수를 통해 하나의 스레드만 임계 구역에 진입.
- 다른 스레드는 대기 큐에서 sleep.
- 비효율적일 수 있음: 짧은 임계 구역이면 컨텍스트 스위칭 비용이 더 큼.

### 스핀락 (Spinlock) - Lock 방식

- Busy-waiting으로 락이 풀릴 때까지 계속 검사.
- 멀티코어 환경에서 짧은 임계 구역에 적합.
- 단일 CPU에서는 비효율적.

### 3) 뮤텍스 vs 스핀락 비교

| 항목             | 뮤텍스       | 스핀락            |
|------------------|--------------|--------------------|
| 대기 방식        | Sleep-Waiting| Busy-Waiting       |
| 연산 비용        | 낮음         | 높음 (CPU 계속 사용) |
| 적합한 환경      | 단일 코어    | 멀티 코어         |
| 주 사용처        | 사용자 코드  | 커널, 인터럽트 루틴 |

### 세마포 (Semaphore) - Wait-Signal 방식

- 다수 자원의 접근을 제어하는 동기화 기법.
- 구성요소:
    - Counter 변수: 사용 가능한 자원 수
    - 대기 큐
    - P(wait), V(signal) 연산

#### P/V 연산

- P(wait): 자원 요청 → 자원 수 감소
- V(signal): 자원 반환 → 자원 수 증가

### 카운터 세마포 vs 이진 세마포

- 카운터 세마포: 자원이 여러 개인 경우
- 이진 세마포: 자원이 하나인 경우 → 뮤텍스와 유사
- 구성 요소:
    - 세마포 변수 (0 또는 1)
    - 대기 큐
    - P/V 원자 연산

### 우선순위 역전

- 낮은 우선순위 스레드가 자원을 점유해 높은 우선순위 스레드가 대기하는 현상.
- 우선순위 올림 / 우선순위 상속 기법으로 해결.

---

## 4. 생산자 소비자 문제

### 생산자 소비자 문제 개요

- 공유 버퍼를 사용하는 생산자와 소비자가 자원을 안전하게 사용하는 문제.
- 발생 가능한 문제점:
    - 공유 버퍼에 대한 상호배제
    - 버퍼가 비었을 때 소비자 접근
    - 버퍼가 꽉 찼을 때 생산자 접근

### 해결 방안

- 세마포의 P/V 연산으로 버퍼 상태에 따라 대기/진입 조절.

---

### 참고자료

[스레드의 동기화](https://gkgktkdwl.tistory.com/30)