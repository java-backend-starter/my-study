# 병행제어(Concurrency Control)

---

## 1. 동시성 제어 (Concurrency Control)

### 정의

- 다중 사용자 환경에서 여러 트랜잭션이 동시에 실행될 때 데이터베이스의 일관성을 유지하도록 트랜잭션 실행 순서를 제어하는 기법.
- 병행제어라고도 하며, 트랜잭션 직렬성(Serializability)을 보장한다.

### 필요성

- 여러 트랜잭션이 하나의 값에 접근할 때 데이터 무결성 문제(오손 읽기, 반복 불가능 읽기, 유령 데이터 읽기, 갱신 손실 등) 발생 가능.
- 따라서 직렬성 보장, 처리량 최대화, 응답시간 최소화, 데이터 무결성/일관성 유지가 필요하다.

---

## 2. 동시성 제어를 하지 않을 때 발생하는 문제

| 문제 | 설명 |
|:----|:----|
| 갱신 손실 (Lost Update) | 두 트랜잭션이 동시에 데이터를 갱신해 변경 사항이 덮어써지는 현상. |
| 현황 파악 오류 (Dirty Read) | 커밋되지 않은 다른 트랜잭션의 중간 데이터를 읽어 잘못된 결과를 도출하는 현상. |
| 모순성 (Inconsistency) | 일부 데이터는 갱신 전, 일부는 갱신 후 값을 읽어 데이터 불일치가 발생하는 현상. |
| 연쇄 복귀 (Cascading Rollback) | 한 트랜잭션이 실패하여 롤백될 때, 이를 참조한 다른 트랜잭션도 함께 롤백해야 하는 상황. |

---

## 3. 주요 동시성 제어 기법

### Locking (락킹)

- 트랜잭션이 데이터에 접근하기 전 Lock을 걸어 제어.
- 종류:
    - 공유 락 (Shared Lock, LS): 읽기 전용 락.
    - 배타 락 (Exclusive Lock, LX): 읽기/쓰기 가능 락.
- 규칙:
    - 락 없는 데이터는 락을 걸 수 있다.
    - 공유 락은 다른 공유 락과 병행 가능, 배타 락은 단독만 가능.
    - 허용되지 않은 락 요청 시 대기 상태.

### 2단계 락킹 (2PL, Two Phase Locking)

- 트랜잭션을 확장 단계(Growing) 와 축소 단계(Shrinking) 로 구분.
    - 확장 단계: 락만 설정, 해제 불가
    - 축소 단계: 해제만 가능, 락 설정 불가
- 직렬 가능성 보장하지만 데드락(Deadlock) 발생 가능.
    - 데드락: 서로 상대의 락 해제를 기다리다 무한 대기 상태가 되는 현상.

### 타임스탬프 순서 기법 (Timestamp Ordering)

- 트랜잭션에 고유 타임스탬프를 부여하여 실행 순서를 미리 결정.
- 교착상태 방지 가능.
- 하지만 RollBack 발생률이 높고 연쇄 복귀 발생 가능.

### 낙관적 검증 (Optimistic Concurrency Control)

- 트랜잭션 수행 중에는 검사 없이 진행, 종료 시 일괄 검사.
- 3단계로 나눔: 읽기(Read), 검증(Validation), 쓰기(Write).
- 충돌이 없으면 Commit, 있으면 Rollback.

### 다중 버전 병행 제어 (MVCC, Multiversion Concurrency Control)

- 하나의 데이터에 여러 버전을 저장해 트랜잭션이 각자 적합한 버전을 읽도록 함.
- 판독(read) 연산이 많은 시스템에서 유리.
- 충돌 발생 시 대기 없이 Rollback 처리 → 연쇄 복귀 가능성 존재.

---

## 3.  동시성 제어 기법 비교

| 기법            | 장점                                          | 단점                                      |
|-----------------|---------------------------------------------|-----------------------------------------|
| Locking(2PL)    | - 데이터 오류 가능성 예방<br>- 간단한 알고리즘   | - Lock 대기시간 발생<br>- Deadlock 발생   |
| Timestamp       | - Deadlock 발생 없음<br>- 트랜잭션 대기 시간 없음 | - Rollback 발생 확률 높음<br>- Cascading Rollback 가능 |
| 낙관적 검증      | - 동시 처리 능력 증가<br>- 트랜잭션 대기 시간 없음 | - 장기 트랜잭션 철회 시 자원 낭비          |
| MVCC            | - 최근 데이터 값을 선택<br>- 동시성, 일관성 동시 해결 | - Undo 블록 I/O에 따른 오버헤드 발생      |

---

### 참고자료

[병행제어](https://s-y-130.tistory.com/m/232)