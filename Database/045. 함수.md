# 함수

---

## 1. 함수(Function)

- 정의: 입력값을 처리하여 결과값을 반환하는 프로그램.
- 종류
  - 내장 함수 (Built-in Function): DBMS에서 기본 제공. 
    - 단일 행 함수 (Single-Row Function): 하나의 입력 → 하나의 출력. 
    - 다중 행 함수 (Multi-Row Function): 여러 입력 → 하나의 출력 (예: 집계 함수).
  - 사용자 정의 함수 (User Defined Function): 사용자가 직접 작성하여 사용하는 함수.

---

## 2. 단일 행 함수

- 단일 행 함수의 유형은 문자형 함수, 숫자형 함수, 날짜형 함수, 형 변환 함수, NULL 관련 함수가 있다.

### 문자형 함수

- 문자형 함수는 문자 또는 문자열을 입력받아 처리하는 함수로, SELECT, WHERE, ORDER BY절에서 사용할 수 있다.

| 함수 | 내용                                                                                           |
|------|----------------------------------------------------------------------------------------------|
| `LOWER(문자열)` | 문자열을 소문자로 변환합니다.                                                                             |
| `UPPER(문자열)` | 문자열을 대문자로 변환합니다.                                                                             |
| `INITCAP(문자열)` | 문자열의 첫 문자를 대문자로 변환합니다. (Pascal Case)                                                         |
| `ASCII(문자)` | 문자를 아스키 코드로 변환합니다.                                                                           |
| `CHR(아스키 코드)` | 아스키 코드를 문자로 변환합니다. (SQL Server에서는 `CHAR()` 사용)                                               |
| `CONCAT(문자열1, 문자열2)` | 문자열1과 문자열2를 연결합니다.(= `문자열 1 \|\| 문자열2`)                                                      |
| `SUBSTR(문자열, 시작위치[, 길이])` | 문자열의 시작위치에서 길이만큼 반환. 길이를 생략하면 끝까지 반환. 시작위치가 음수면 오른쪽에서부터 계산. (SQL Server에서는 `SUBSTRING()` 사용) |
| `LENGTH(문자열)` | 문자열의 길이를 반환합니다. 바이트 단위는 `LENGTHB()` 사용. (SQL Server에서는 `LEN()` 사용)                           |
| `LTRIM(문자열[, 지정문자])` | 문자열 왼쪽에서 지정문자 제거. 생략 시 공백 제거.                                                                |
| `RTRIM(문자열[, 지정문자])` | 문자열 오른쪽에서 지정문자 제거. 생략 시 공백 제거.                                                               |
| `TRIM([LEADING \| TRAILING \| BOTH] [지정문자 FROM] 문자열)` | 문자열의 앞, 뒤, 또는 양쪽에서 지정문자 제거. 생략 시 공백 제거.                                                      |
| `LPAD(문자열, 길이[, 채움문자])` | 문자열 왼쪽에 채움문자를 채워 지정 길이로 만듭니다. 생략 시 공백 사용.                                                    |
| `RPAD(문자열, 길이[, 채움문자])` | 문자열 오른쪽에 채움문자를 채워 지정 길이로 만듭니다. 생략 시 공백 사용.                                                   |
| `REPLACE(문자열, 지정문자열, 변환문자열)` | 문자열 내 지정문자열을 변환문자열로 변경합니다.                                                                   |
| `TRANSLATE(문자열, 지정문자열, 변환문자열)` | `REPLACE`와 유사하나, 지정문자열의 문자들을 변환문자열의 대응 문자로 일괄 치환합니다.                                         |

### 숫자형 함수

- 숫자형 함수는 수치형 데이터를 입력받아 처리하는 함수이다.

| 함수                     | 내용                                      |
|--------------------------|-------------------------------------------|
| `ABS(숫자)`                | 숫자의 절대값을 반환합니다.                |
| `SIGN(숫자)`               | 숫자가 양수이면 1, 음수이면 -1, 0이면 0을 반환합니다. |
| `MOD(숫자1, 숫자2)`        | 숫자1을 숫자2로 나눈 나머지를 반환합니다.    |
| `CEIL(숫자)`               | 숫자의 올림값을 반환합니다.                |
| `FLOOR(숫자)`              | 숫자의 내림값을 반환합니다.                |
| `ROUND(숫자[, 소수점자리수])` | 숫자를 소수점 자릿수에서 반올림합니다. 소수점자리수를 생략하면 기본값으로 0이 적용됩니다. |
| `TRUNC(숫자[, 소수점자리수])` | 숫자의 소수점 자릿수 뒷자리를 버립니다.      |

### 날짜형 함수

- 날짜형 함수는 DATE 타입의 데이터를 계산한다.

| 함수                                       | 내용                                |
|------------------------------------------|-------------------------------------|
| `SYSDATE`                                | 현재 날짜와 시간을 반환합니다. SQL Server에서는 GETDATE()를 사용합니다. |
| `EXTRACT (YEAR \| MONTH \| DAY FROM 날짜)` | 날짜에서 년(YEAR), 월(MONTH), 일(DAY)을 추출합니다. SQL Server에서는 DATEPART()를 사용합니다. |

### 형 변환 함수

- 형 변환 함수는 데이터 타입을 변환하기 위해 사용하는 함수이다.

| 함수                        | 내용                              |
|---------------------------|-----------------------------------|
| `TO_NUMBER(문자열)`          | 문자열을 숫자로 변환합니다.      |
| `TO_CHAR(숫자 \| 날짜[, 포맷])` | 숫자 또는 날짜를 포맷에 맞는 문자열로 변환합니다. |
| `TO_DATE(문자열[, 포맷])`      | 문자열을 포맷에 맞는 날짜 타입으로 변환합니다. |

### NULL 관련 함수

- NULL 관련 함수는 정해지지 않은 값을 의미하며, 과 관련된 함수는 다음과 같다.

| 함수                          | 내용                                      |
|-------------------------------|-------------------------------------------|
| `NVL(표현식1, 표현식2)`          | 표현식1이 NULL이면 표현식2를 반환합니다. SQL Server에서는 ISNULL()을 사용합니다. |
| `NVL2(표현식1, 표현식2, 표현식3)` | 표현식1이 NULL이 아니면 표현식2를, NULL이면 표현식3을 반환합니다. |
| `IFNULL(표현식1, 표현식2)`       | 표현식1과 표현식2가 같으면 NULL을, 같지 않으면 표현식1을 반환합니다. |
| `COALESCE(표현식1, 표현식2, …)`  | 표현식 중 NULL이 아닌 첫번째 값을 반환합니다. |

---

## 3. 다중 행 함수

- 다중 행 함수의 유형은 집계 함수, 그룹 함수, 윈도우 함수가 있다.

### 집계 함수

- 집계 함수는 특정 컬럼에 대한 행들의 값을 통계적으로 계산한 결과를 반환하는 함수이다. 
- SELECT절, HAVING절, GROUP BY절에 사용할 수 있으며, 값은 제외하고 계산됩니다.

| 함수 | 내용 |
|------|------|
| `COUNT(*)` | 값을 포함한 컬럼 전체 행의 수를 반환합니다. |
| `COUNT(컬럼 \| 표현식)` | NULL을 제외한 컬럼 또는 표현식의 행 수를 반환합니다. |
| `SUM(컬럼 \| 표현식)` | 컬럼 또는 표현식의 합계를 반환합니다. |
| `AVG(컬럼 \| 표현식)` | 컬럼 또는 표현식의 평균을 반환합니다. |
| `MAX(컬럼 \| 표현식)` | 컬럼 또는 표현식의 최대값을 반환합니다. |
| `MIN(컬럼 \| 표현식)` | 컬럼 또는 표현식의 최소값을 반환합니다. |
| `STDDEV(컬럼 \| 표현식)` | 컬럼 또는 표현식의 표준편차를 반환합니다. |
| `VARIANCE(컬럼 \| 표현식)` | 컬럼 또는 표현식의 분산을 반환합니다. |

### 그룹 함수

- 그룹 함수는 데이터를 그룹화하고 각 그룹 내의 데이터를 분석하는 데 사용되는 함수이다. 
- SELECT 문에서 사용되며 일반적으로 GROUP BY 구문과 함께 사용된다.

#### ROLLUP 함수  

- ROLLUP 함수는 지정된 컬럼의 소계 및 총계를 구하기 위해 사용하는 그룹 함수이다. 
- 각 열을 기준으로 데이터를 그룹화하고, 각 그룹에 대해 집계 연산을 수행한 다음, 상위 수준에서도 그룹화 및 집계를 수행한다.

##### ROLLUP 함수 구문

```sql
SELECT 컬럼명, 집계 함수
  FROM 테이블명
 GROUP BY ROLLUP(컬럼1, 컬럼2);
```

#### CUBE 함수

- CUBE 함수는 다차원 그룹화를 수행하기 위한 기능이다. 
- ROLLUP 함수와 마찬가지로 GROUP BY 절에 사용되며, 여러 열을 기준으로 데이터를 그룹화하고 각 그룹 단위의 합계를 계산한다. 
- 하지만, ROLLUP 함수와 달리 CUBE 함수는 모든 가능한 조합에 대한 그룹 단위의 합계를 계산힌다.

##### CUBE 함수 구문

```sql
SELECT 컬럼명, 집계 함수
FROM 테이블명
GROUP BY CUBE(컬럼1, 컬럼2);
```

#### GROUPING SETS 함수

- GROUPING SETS 함수는 다중 그룹화를 수행하기 위한 기능이다. 
- ROLLUP 함수 및 CUBE 함수와 비슷하지만, GROUPING SETS 함수는 그룹화에 대한 집합을 명시적으로 지정할 수 있다.

##### GROUPING SETS 함수 구문

```sql
SELECT 컬럼명, 집계 함수
FROM 테이블명
GROUP BY GROUPING SETS(컬럼1, 컬럼2);
```

---

## 4. 사용자 정의 함수

### 개념

- SQL을 사용하여 일련의 작업을 처리한 후 단일 값을 반환하는 절차형 SQL.
- SELECT, INSERT, UPDATE, DELETE 등의 DML문 안에서 호출하여 사용.
- RETURN 예약어를 통해 결과 값을 반환 (출력 파라미터는 없음).
- 조회(SELECT)만 가능, 테이블 조작(INSERT, UPDATE, DELETE)은 불가능.
- 프로시저 호출 불가.
- `SUM()`, `AVG()` 같은 내장 함수처럼 사용 가능.

### 프로시저 vs 사용자 정의 함수

| 구분 | 프로시저 | 사용자 정의 함수 |
|------|----------|------------------|
| 반환값 | 없음 또는 여러 개 가능 | 단일값만 가능 |
| 파라미터 | 입력/출력 모두 가능 | 입력만 가능 (`IN`) |
| 사용 가능한 명령 | DML, DCL 등 다양 | SELECT |
| 호출 가능 대상 | 프로시저, 함수 | 함수만 |
| 사용 방법 | 독립 실행 | DML 내부에서 사용 |

### 구성 요소

```sql
DECLARE(필수)
BEGIN
    CONTROL
    SQL
    EXCEPTION
    RETURN(필수)
END (필수)
```

| 구성 요소 | 설명 |
|-----------|------|
| `DECLARE` | 함수명, 변수, 인수, 자료형 선언 |
| `BEGIN ~ END` | 함수 실행 블록 |
| `CONTROL` | 조건문/반복문 등 로직 제어 |
| `SQL` | SELECT문 등 조회 작업 |
| `EXCEPTION` | 예외 처리 |
| `RETURN` | 반환할 값 지정 |

### 생성 문법

```sql
CREATE [OR REPLACE] FUNCTION 함수명(파라미터)
RETURN 반환자료형
IS
  -- 지역 변수 선언 가능
BEGIN
  -- SQL 및 로직 처리
  RETURN 반환값;
END;
```
- `OR REPLACE`: 동일한 이름의 함수가 있으면 덮어쓰기.
- 파라미터: `IN`만 사용, 출력 없음.
- `RETURN`: 반환값 자료형만 정의, 크기 지정은 필요 없음.

### 예제: 성별 반환 함수

```sql
CREATE FUNCTION Get_S_성별(i_성별코드 IN INT)
RETURN VARCHAR2
IS
BEGIN
  IF i_성별코드 = 1 THEN
    RETURN '남자';
  ELSE
    RETURN '여자';
  END IF;
END;
```
1. 파라미터로 'i_성별코드'를 전달받는 사용자 정의 함수 'Get_S_성별'을 생성한다.
2. 블록에서 리턴할 데이터의 자료형을 정의한다. 자료형의 크기는 입력할 필요 없다.
    - 형식: RETURN [자료형]
3. 변수 선언을 위해 사용하는 예약어로 변수를 사용하지 않으므로 예약어만 입력한다.
4. 'i_성별코드'가 1이면 "남자"를 반환하고
5. 'i_성별코드'가 1이 아니면 "여자"를 반환한다.
6. IF문의 끝

### 실행 예시

```sql
SELECT 이름, Get_S_성별(성별코드) FROM 사원;
```

#### 사원 테이블

| 이름   | 성별코드 |
|--------|----------|
| 김대진 | 1        |
| 이고을 | 2        |
| 최승규 | 1        |
| 송하나 | 2        |

#### 출력 결과

| 이름   | Get_S_성별(성별코드) |
|--------|-----------------------|
| 김대진 | 남자                  |
| 이고을 | 여자                  |
| 최승규 | 남자                  |
| 송하나 | 여자                  |

### 함수 삭제

- 표기 형식
```sql
DROP FUNCTION 사용자 정의 함수명;
```
- 예시
```sql
DROP FUNCTION Get_S_성별;
```

---

### 참고자료

[내장 함수](https://huimang2.github.io/sql/built-in-function)

[사용자 정의 함수](https://velog.io/@alpaka206/88.-%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%A0%95%EC%9D%98-%ED%95%A8%EC%88%98)