# 데이터 압축(Compression)

---

## 1. 개요

- 디스크에 저장된 데이터 파일의 크기가 클수록 쿼리 처리 성능이 낮아지고 백업 및 복구 시간이 길어진다. 
- 이를 해결하기 위해 많은 DBMS는 데이터 압축 기능을 제공한다. 
- MySQL은 페이지 압축과 테이블 압축 두 가지 방식의 데이터 압축 기능을 지원한다.

---

## 2. 페이지 압축 (Transparent Page Compression)

- MySQL 서버에서 데이터를 디스크에 저장할 때, 데이터 페이지가 압축되어 저장되고, 데이터를 읽어올 때 압축이 해제되는 방식입니다. 이 방식은 MySQL 서버의 내부 코드에서 압축 여부와 관계없이 투명하게 작동한다. 
- 그러나 이 방식에는 두 가지 주요 단점이 있다
  - 데이터 페이지 압축 용량 예측 불가능
    - 압축된 데이터 페이지의 크기가 예측할 수 없어, 효율적인 공간 관리가 어렵다.
  - 동일한 크기의 페이지 요구
    - MySQL에서는 모든 테이블이 동일한 크기의 페이지로 통일되어야 합니다.
- 이 문제를 해결하기 위해 펀치 홀(Punch Hole) 기능을 사용한다. 페이지 압축이 작동하는 방식은 다음과 같다. 
  - 16KB 페이지가 압축되어 7KB로 줄어든다고 가정한다. 
  - MySQL은 디스크에 압축된 7KB 데이터를 저장하고, 추가로 9KB의 빈 공간을 기록한다. 
  - 이후, 파일 시스템은 7KB만 남기고 나머지 9KB는 운영체제에 반납한다.
- 그러나 펀치 홀 기능은 운영체제 및 하드웨어와 파일 시스템 명령어에서 지원해야 한다. 
- 만약 펀치 홀이 지원되지 않으면, MySQL 서버의 데이터 파일을 백업 및 복구할 때 실제 데이터 파일 크기가 원본 크기로 남을 수 있다.
- 이러한 이유로 페이지 압축은 많이 사용되지 않습니다.

---

## 3. 테이블 압축

- 페이지 압축과 달리 OS나 하드웨어에 대한 제약이 없으며 활용도가 높다. 
- 그러나 다음과 같은 단점이 있다.
  - 버퍼 풀 공간 활용률 낮음 
  - 쿼리 처리 성능 저하 
  - 빈번한 데이터 변경 시 압축률 감소

### 압축 테이블 생성

- 압축을 사용할 테이블은 별도의 테이블 스페이스를 사용해야 하며, innodb_file_per_table을 ON으로 설정해야 한다. 
- ROW_FORMAT=COMPRESSED와 KEY_BLOCK_SIZE 옵션을 사용하여 테이블을 생성한다.
- 예시
```mysql-sql
-- // ROW_FORMAT 옵션과 KEY_BLOCK_SIZE 옵션을 모두 명시
CREATE TABLE compressed_table (
    c1 INT PRIMARY KEY,
)
ROW_FORMAT=COMPRESSED
KEY_BLOCK_SIZE=8;

-- // KEY_BLOCK_SIZE 옵션만 명시
CREATE TABLE compressed_table (
    c1 INT PRIMARY KEY,
) KEY_BLOCK_SIZE=8;
```
- InnoDB 스토리지 엔진의 데이터 페이지(블록)가 16KB이고, `KEY_BLOCK_SIZE=8`인 경우, 압축 적용 방법은 다음과 같다.
- 16KB 데이터 페이지 압축
  - 압축된 결과가 8KB 이하인 경우: 압축된 데이터를 그대로 디스크에 저장 (압축 완료)
  - 압축된 결과가 8KB보다 큰 경우: 원본 페이지를 두 개의 8KB 페이지로 분리하여 저장 (압축 실패)
    - 분리된 각 페이지에 대해 1 과정이 재귀적으로 반복됩니다.

이 방식에서 `KEY_BLOCK_SIZE` 값은 압축 성공률을 결정하는 중요한 요소입니다.



### KEY_BLOCK_SIZE 결정

- KEY_BLOCK_SIZE 값은 압축 성능에 큰 영향을 미친다. 
- 이를 4KB, 8KB 등으로 설정하여 샘플 데이터를 저장한 후 압축 성공률을 확인한다.
- 압축 실패율은 3%~5% 미만을 유지하는 것이 좋으며, 압축 실패율이 높더라도 압축으로 인해 데이터 크기가 많이 줄어드는 경우에는 압축을 고려할 수 있다.
- 자주 조회나 변경되는 테이블의 경우 압축을 피하는 것이 좋습니다.

### 압축된 페이지의 버퍼 풀 적재 및 사용

- 압축된 페이지는 두 가지 버전(압축된 상태와 해제된 상태)을 버퍼 풀에 관리하며, 이로 인해 메모리 낭비가 발생할 수 있다. 
- 또한, 압축을 해제하려면 많은 CPU 자원이 소모된다. 
- 이를 보완하기 위해 InnoDB는 Unzip_LRU 리스트를 관리하여 유입되는 쿼리 패턴에 맞게 적절히 처리한다.

---

### 참고자료

[데이터 압축(Compression)](https://velog.io/@kmw89891/%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%95%95%EC%B6%95)